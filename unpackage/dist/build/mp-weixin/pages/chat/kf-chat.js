(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/kf-chat"],{"1bfc":function(t,e,i){"use strict";var o;i.d(e,"b",(function(){return s})),i.d(e,"c",(function(){return n})),i.d(e,"a",(function(){return o}));var s=function(){var t=this,e=t.$createElement,i=(t._self._c,t.__map(t.messageList,(function(e,i){var o=t.__get_orig(e),s=0==e.creator&&1==e.type?e.message.replace(/\n/g,"<br>"):null;return{$orig:o,g0:s}})));t.$mp.data=Object.assign({},{$root:{l0:i}})},n=[]},2597:function(t,e,i){"use strict";(function(t){i("77c6");o(i("66fd"));var e=o(i("8dcf"));function o(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,i("543d")["createPage"])},"40ba":function(t,e,i){},4212:function(t,e,i){"use strict";var o=i("40ba"),s=i.n(o);s.a},"5dc0":function(t,e,i){"use strict";i.r(e);var o=i("b3fb"),s=i.n(o);for(var n in o)"default"!==n&&function(t){i.d(e,t,(function(){return o[t]}))}(n);e["default"]=s.a},"8dcf":function(t,e,i){"use strict";i.r(e);var o=i("1bfc"),s=i("5dc0");for(var n in s)"default"!==n&&function(t){i.d(e,t,(function(){return s[t]}))}(n);i("4212");var a,c=i("f0c5"),r=Object(c["a"])(s["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],a);e["default"]=r.exports},b3fb:function(t,e,i){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=n(i("a34a")),s=n(i("40b6"));function n(t){return t&&t.__esModule?t:{default:t}}function a(t,e,i,o,s,n,a){try{var c=t[n](a),r=c.value}catch(l){return void i(l)}c.done?e(r):Promise.resolve(r).then(o,s)}function c(t){return function(){var e=this,i=arguments;return new Promise((function(o,s){var n=t.apply(e,i);function c(t){a(n,o,s,c,r,"next",t)}function r(t){a(n,o,s,c,r,"throw",t)}c(void 0)}))}}var r={data:function(){return{platform:"",isJurisdiction:"",account:"",id:"",img:"",name:"",pageNum:1,pageSize:15,imageUrl:null,messageList:[],textMsg:"",isHistoryLoading:!1,scrollAnimation:!0,scrollTop:0,scrollToView:"",msgList:[],msgImgList:[],myuid:0,RECORDER:t.getRecorderManager(),isVoice:!1,voiceTis:"按住 说话",recordTis:"手指上滑 取消发送",recording:!1,willStop:!1,initPoint:{identifier:0,Y:0},recordTimer:null,recordLength:0,AUDIO:t.createInnerAudioContext(),playMsgid:null,VoiceTimer:null,popupLayerClass:"",hideMore:!0,focus:!1}},onLoad:function(e){var i=this;return c(o.default.mark((function n(){var a,c;return o.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:i.id=t.getStorageSync(i.KFCHATID),i.getMessageData(),i.name=e.name,i.img=JSON.parse(decodeURIComponent(e.img)),console.log("自己头像"+t.getStorageSync(i.HEADIMG)),i.imageUrl=t.getStorageSync(i.HEADIMG),console.log("接收："+i.name+i.img),t.setNavigationBarTitle({title:i.name}),a=t.getStorageSync(i.id+""),i.$u.test.isEmpty(a)||(i.messageList=a,console.log("获取到缓存的数据2"),console.log(i.messageList),i.$nextTick((function(){this.scrollTop=9999,this.$nextTick((function(){this.scrollAnimation=!0}))}))),i.AUDIO.onEnded((function(t){i.playMsgid=null})),i.platform=t.getSystemInfoSync().platform,"ios"==i.platform?(console.log("我是iOS"),i.isJurisdiction=s.default.judgeIosPermission("record")):"android"==i.platform&&console.log("我是安卓"),i.RECORDER.onStart((function(t){i.isJurisdiction||"ios"!=i.platform||(i.isJurisdiction=s.default.judgeIosPermission("record")),i.isJurisdiction&&i.recordBegin(t)})),i.RECORDER.onStop((function(t){i.isJurisdiction&&i.recordEnd(t)})),c=i,t.$on(i.SOCKETKFCHAT,(function(t){console.log("kf患者收到服务器通知："+t);var e=JSON.parse(t);0==e[0].creator&&(console.log("当前集合："+c.messageList),c.messageList=c.messageList.concat(e),console.log("滚动到最下面的id"),console.log(e[0].id),c.$nextTick((function(){c.scrollToView="msg"+e[0].id,c.$nextTick((function(){c.scrollAnimation=!0}))})),2==e[0].type&&c.msgImgList.push(e[0].content))})),t.onKeyboardHeightChange((function(t){console.log("软键盘高度监听"+t.height),0==t.height&&(i.focus=!1,i.hideDrawer())}));case 18:case"end":return o.stop()}}),n)})))()},onShow:function(){this.scrollTop=9999999},onHide:function(){this.hideDrawer()},onUnload:function(){t.$off(this.SOCKETKFCHAT)},methods:{getMessageData:function(){var e=this;this.$u.get(this.ChattingChatRecordUrl,{id:this.id,pageNum:this.pageNum,pageSize:this.pageSize}).then((function(i){if(!e.$u.test.isEmpty(i.data.list)){var o=i.data.list.reverse();e.messageList=o,console.log("去22缓存的数据"),console.log(e.id+e.messageList),t.setStorageSync(e.id+"",e.messageList),console.log("去缓存的数据"),console.log(e.messageList);for(var s=0;s<o.length;s++)2==o[s].type&&e.msgImgList.push(o[s].message);e.$nextTick((function(){this.scrollTop=9999,this.$nextTick((function(){this.scrollAnimation=!0}))}))}})).catch((function(t){1==t.data.status&&(console.log(t.data.msg),e.isHistoryLoading=!1)}))},toVideo:function(e){t.navigateTo({url:"../video/big-video?videoUrl="+e+"&title=视频"})},getVideo:function(){var e=this;this.hideDrawer(),t.chooseVideo({maxDuration:60,count:1,success:function(t){var i=t.tempFilePath;console.log("要上传的视频"),console.log(i),e.postVideo(i)}})},postVideo:function(e){var i=this,o=this;t.showLoading(),t.uploadFile({url:this.websocketOtherSendUrl,filePath:e,name:"file",header:{"Content-Type":"application/json",token:t.getStorageSync("token")},formData:{type:4,chattingId:o.id},success:function(e){t.hideLoading(),console.log("成功"),console.log(e),console.log(JSON.parse(e.data));var s=JSON.parse(e.data);0==s.status?(console.log("上传视频成功"),o.getNewData()):1==s.status&&i.$u.toast(s.msg)}})},loadHistory:function(t){var e=this;if(!this.isHistoryLoading){this.pageNum++,this.isHistoryLoading=!0,this.scrollAnimation=!1;var i=this.messageList[0].id;this.$u.get(this.ChattingChatRecordUrl,{id:this.id,pageNum:this.pageNum,pageSize:this.pageSize}).then((function(t){e.isHistoryLoading=!1;for(var o=t.data.list,s=0;s<o.length;s++)2==o[s].type&&e.msgImgList.push(o[s].content),e.messageList.unshift(o[s]);console.log("所有消息"),console.log(e.messageList),e.$nextTick((function(){this.scrollToView="msg"+i,this.$nextTick((function(){this.scrollAnimation=!0}))}))})).catch((function(t){4==t.data.status&&(e.$u.toast("已加载全部消息"),e.isHistoryLoading=!1)}))}},showMore:function(){this.isVoice=!1,this.hideMore?(this.hideMore=!1,this.openDrawer()):this.hideDrawer()},openDrawer:function(){this.popupLayerClass="showLayer"},hideDrawer:function(){var t=this;this.popupLayerClass="",setTimeout((function(){t.hideMore=!0}),150)},getImage:function(){this.hideDrawer();var e=this;t.chooseImage({count:1,sizeType:["compressed"],success:function(t){console.log(JSON.stringify(t.tempFilePaths[0])),console.log(e.id),e.sendImg(t.tempFilePaths[0])}})},sendImg:function(e){var i=this,o=this;t.showLoading(),t.uploadFile({url:this.websocketOtherSendUrl,filePath:e,name:"file",header:{"Content-Type":"application/json",token:t.getStorageSync("token")},formData:{type:2,chattingId:o.id},success:function(e){t.hideLoading(),console.log("成功"),console.log(e),console.log(JSON.parse(e.data));var s=JSON.parse(e.data);0==s.status?(console.log("上传成功"),o.getNewData()):1==s.status&&i.$u.toast(s.msg)}})},textareaFocus:function(){this.focus=!0,"showLayer"==this.popupLayerClass&&this.hideDrawer()},sendText:function(){this.textMsg&&(this.sendMsg(this.textMsg),this.textMsg="")},sendMsg:function(t){var e=this;console.log("要发送的信息"),console.log(t),this.$u.post(this.websocketOtherSendUrl,{message:t,type:1,chattingId:this.id}).then((function(t){e.getNewData(),console.log("发送消息成功"),console.log(t)})).catch((function(t){e.$u.toast(t.data.msg)}))},getNewData:function(){var e=this;console.log("开始获取第一条消息"),this.$u.get(this.ChattingChatRecordUrl,{id:this.id,pageNum:1,pageSize:1}).then((function(i){t.hideLoading();var o=i.data.list;console.log("最新获取到的消息"),console.log(o),e.messageList=e.messageList.concat(o),console.log("滚动到最下面的id"),console.log(o[0].id),e.$nextTick((function(){this.scrollToView="msg"+o[0].id,this.$nextTick((function(){this.scrollAnimation=!0}))})),2==o[0].type&&e.msgImgList.push(o[0].message),0==o[0].creator&&t.vibrateLong()}))},showPic:function(e){t.previewImage({indicator:"none",current:e,urls:this.msgImgList})},playVoice:function(t,e){this.playMsgid=e,this.AUDIO.src=t,this.$nextTick((function(){this.AUDIO.play()}))},voiceBegin:function(t){console.log("开始录制"),console.log(t),t.touches.length>1||(this.initPoint.Y=t.touches[0].clientY,this.initPoint.identifier=t.touches[0].identifier,this.RECORDER.start({format:"mp3"}))},recordBegin:function(t){var e=this;this.recording=!0,this.voiceTis="松开 结束",this.recordLength=0,this.recordTimer=setInterval((function(){e.recordLength++}),1e3)},voiceCancel:function(){this.recording=!1,this.voiceTis="按住 说话",this.recordTis="手指上滑 取消发送",this.willStop=!0,this.RECORDER.stop()},voiceIng:function(e){if(this.recording){var i=e.touches[0];this.initPoint.Y-i.clientY>=t.upx2px(100)?(this.willStop=!0,this.recordTis="松开手指 取消发送"):(this.willStop=!1,this.recordTis="手指上滑 取消发送")}},voiceEnd:function(t){this.recording&&(this.recording=!1,this.voiceTis="按住 说话",this.recordTis="手指上滑 取消发送",this.RECORDER.stop())},recordEnd:function(e){var i=this,o=this;if(clearInterval(this.recordTimer),this.willStop)console.log("取消发送录音");else{if(console.log("要上传的语音"),console.log(e.tempFilePath),console.log("要上传语音的时长"),console.log(this.recordLength),this.recordLength<1)return void this.$u.toast("时间过短，请重新录制");t.uploadFile({url:this.websocketOtherSendUrl,method:"POST",filePath:e.tempFilePath,name:"file",header:{"Content-Type":"application/json",token:t.getStorageSync("token")},formData:{type:3,chattingId:o.id},success:function(e){t.hideLoading(),console.log("成功"),console.log(e),console.log(JSON.parse(e.data));var s=JSON.parse(e.data);0==s.status?(console.log("上传语音成功"),o.getNewData()):1==s.status&&i.$u.toast(s.msg)}})}this.willStop=!1},switchVoice:function(){this.hideDrawer(),this.isVoice=!this.isVoice},discard:function(){}}};e.default=r}).call(this,i("543d")["default"])}},[["2597","common/runtime","common/vendor"]]]);