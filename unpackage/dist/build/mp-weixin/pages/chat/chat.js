(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{1001:function(t,e,i){"use strict";(function(t){i("77c6");o(i("66fd"));var e=o(i("78a7"));function o(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,i("543d")["createPage"])},"32bc":function(t,e,i){"use strict";var o=i("9e8e"),n=i.n(o);n.a},"39b4":function(t,e,i){"use strict";i.r(e);var o=i("cd97"),n=i.n(o);for(var s in o)"default"!==s&&function(t){i.d(e,t,(function(){return o[t]}))}(s);e["default"]=n.a},"78a7":function(t,e,i){"use strict";i.r(e);var o=i("9e25"),n=i("39b4");for(var s in n)"default"!==s&&function(t){i.d(e,t,(function(){return n[t]}))}(s);i("32bc");var c,a=i("f0c5"),r=Object(a["a"])(n["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],c);e["default"]=r.exports},"9e25":function(t,e,i){"use strict";var o;i.d(e,"b",(function(){return n})),i.d(e,"c",(function(){return s})),i.d(e,"a",(function(){return o}));var n=function(){var t=this,e=t.$createElement,i=(t._self._c,t.__map(t.messageList,(function(e,i){var o=t.__get_orig(e),n=e.sendId==t.account&&3!=e.mediaType&&1==e.mediaType?e.content.replace(/\n/g,"<br>"):null;return{$orig:o,g0:n}})));t.$mp.data=Object.assign({},{$root:{l0:i}})},s=[]},"9e8e":function(t,e,i){},cd97:function(t,e,i){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=s(i("a34a")),n=s(i("40b6"));function s(t){return t&&t.__esModule?t:{default:t}}function c(t,e,i,o,n,s,c){try{var a=t[s](c),r=a.value}catch(l){return void i(l)}a.done?e(r):Promise.resolve(r).then(o,n)}function a(t){return function(){var e=this,i=arguments;return new Promise((function(o,n){var s=t.apply(e,i);function a(t){c(s,o,n,a,r,"next",t)}function r(t){c(s,o,n,a,r,"throw",t)}a(void 0)}))}}var r={data:function(){return{platform:"",isJurisdiction:"",type:"",account:"",id:"",img:"",name:"",pageNum:1,pageSize:20,imageUrl:null,messageList:[],textMsg:"",isHistoryLoading:!1,scrollAnimation:!0,scrollTop:0,scrollToView:"",msgList:[],msgImgList:[],myuid:0,RECORDER:t.getRecorderManager(),isVoice:!1,voiceTis:"按住 说话",recordTis:"手指上滑 取消发送",recording:!1,willStop:!1,initPoint:{identifier:0,Y:0},recordTimer:null,recordLength:0,AUDIO:t.createInnerAudioContext(),playMsgid:null,VoiceTimer:null,popupLayerClass:"",hideMore:!0,focus:!1}},onLoad:function(e){var i=this;return a(o.default.mark((function s(){var c;return o.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:console.log("我的id："+t.getStorageSync(i.ID)),i.type=e.type,i.account=e.account,i.name=e.name,i.img=JSON.parse(decodeURIComponent(e.img)),i.id="customer_"+t.getStorageSync(i.ID),c=t.getStorageSync(i.account),i.$u.test.isEmpty(c)||(i.messageList=c,console.log("获取到缓存的数据"),console.log(i.messageList),i.$nextTick((function(){this.scrollTop=9999,this.$nextTick((function(){this.scrollAnimation=!0}))}))),t.setNavigationBarTitle({title:e.name}),i.getMessageData(),console.log("头像"),i.imageUrl=t.getStorageSync(i.HEADIMG),i.AUDIO.onEnded((function(t){i.playMsgid=null})),t.$on(i.INFORMCHATLIST,(function(t){i.getNewData()})),i.platform=t.getSystemInfoSync().platform,"ios"==i.platform?(console.log("我是iOS"),i.isJurisdiction=n.default.judgeIosPermission("record")):"android"==i.platform&&console.log("我是安卓"),i.RECORDER.onStart((function(t){i.isJurisdiction||"ios"!=i.platform||(i.isJurisdiction=n.default.judgeIosPermission("record")),i.isJurisdiction&&i.recordBegin(t)})),i.RECORDER.onStop((function(t){i.isJurisdiction&&i.recordEnd(t)})),t.$on(i.SOCKETCHAT,(function(t){console.log("收到嘻嘻嘻1111"),console.log(t);var e=t;e.sendId==i.account&&(i.messageList=i.messageList.concat(e),console.log("滚动到最下面的id"),console.log(e.id),i.$nextTick((function(){this.scrollToView="msg"+e.id,this.$nextTick((function(){this.scrollAnimation=!0}))})),2==e.mediaType&&i.msgImgList.push(e.content))})),t.onKeyboardHeightChange((function(t){console.log("软键盘高度监听"+t.height),0==t.height&&(i.focus=!1,i.hideDrawer())}));case 20:case"end":return o.stop()}}),s)})))()},onShow:function(){this.scrollTop=9999999},onHide:function(){this.hideDrawer()},onUnload:function(){t.$off(this.INFORMCHATLIST),t.$off(this.SOCKETCHAT)},methods:{toUpbill:function(e){t.navigateTo({url:"../bill-list/bill-list?recordId="+e})},tobill:function(e){t.navigateTo({url:"../bill-list-check/bill-list-check?recordId="+e})},toGoodDetail:function(e){t.navigateTo({url:"../shop-details/shop-details?id="+e})},toVideo:function(e){t.navigateTo({url:"../video/big-video?videoUrl="+e+"&title=视频"})},getVideo:function(){this.hideDrawer();var e=this;t.chooseVideo({maxDuration:60,count:1,success:function(i){var o=i.tempFilePath;console.log("要上传的视频"),console.log(o),t.showLoading(),t.uploadFile({url:e.sendChatUrl,method:"POST",filePath:o,name:"file",formData:{from:e.id,toUser:e.account,mediaType:7},success:function(t){var i=t.data;console.log("上传视频成功"+i),e.getNewData()}})}})},getMessageData:function(){var e=this;this.$u.get(this.customerMsgRecordUrl,{receiver:this.account,pageNum:this.pageNum,pageSize:this.pageSize}).then((function(i){1==e.type&&t.$emit(e.INFORMNOREAD,"");var o=i.data.reverse();e.messageList=o,t.setStorageSync(e.account,e.messageList),console.log("去缓存的数据"),console.log(e.messageList);for(var n=0;n<o.length;n++)2==o[n].mediaType&&e.msgImgList.push(o[n].content);e.$nextTick((function(){this.scrollTop=9999,this.$nextTick((function(){this.scrollAnimation=!0}))}))})).catch((function(t){4==t.data.status&&(console.log(t.data.msg),e.isHistoryLoading=!1)}))},loadHistory:function(t){var e=this;if(!this.isHistoryLoading){this.pageNum++,this.isHistoryLoading=!0,this.scrollAnimation=!1;var i=this.messageList[0].id;this.$u.get(this.customerMsgRecordUrl,{receiver:this.account,pageNum:this.pageNum,pageSize:this.pageSize}).then((function(t){e.isHistoryLoading=!1;for(var o=t.data.reverse(),n=0;n<o.length;n++)2==o[n].mediaType&&e.msgImgList.push(o[n].content),e.messageList.unshift(o[n]);console.log("所有消息"),console.log(e.messageList),e.$nextTick((function(){this.scrollToView="msg"+i,this.$nextTick((function(){this.scrollAnimation=!0}))}))})).catch((function(t){4==t.data.status&&(e.$u.toast("已加载全部消息"),e.isHistoryLoading=!1)}))}},showMore:function(){this.isVoice=!1,this.hideMore?(this.hideMore=!1,this.openDrawer()):this.hideDrawer()},openDrawer:function(){this.popupLayerClass="showLayer"},hideDrawer:function(){var t=this;this.popupLayerClass="",setTimeout((function(){t.hideMore=!0}),150)},getImage:function(){this.hideDrawer();var e=this;t.chooseImage({count:1,sizeType:["compressed"],success:function(t){console.log(JSON.stringify(t.tempFilePaths)),console.log(e.id),console.log(e.account),e.sendImg(t.tempFilePaths[0])}})},sendImg:function(e){var i=this;t.uploadFile({url:this.sendChatUrl,filePath:e,name:"file",formData:{from:this.id,toUser:this.account,mediaType:2},success:function(t){console.log("成功"),console.log(t.data),i.getNewData()}})},textareaFocus:function(){this.focus=!0,"showLayer"==this.popupLayerClass&&this.hideDrawer()},sendText:function(){this.textMsg&&(this.sendMsg(this.textMsg,1),this.textMsg="")},sendMsg:function(t,e){var i=this;console.log("要发送的信息"),console.log(t),console.log(e),console.log(this.id),console.log(this.account),this.$u.get("send/chat?message="+t+"&mediaType="+e+"&from="+this.id+"&file="+t+"&toUser="+this.account).then((function(t){i.getNewData(),console.log("发送消息成功"),console.log(t)}))},getNewData:function(){var e=this;console.log("开始获取第一条消息"),this.$u.get(this.customerMsgRecordUrl,{receiver:this.account,pageNum:1,pageSize:1}).then((function(i){t.hideLoading();var o=i.data;console.log("最新获取到的消息"),console.log(o),e.messageList=e.messageList.concat(o),console.log("滚动到最下面的id"),console.log(o[0].id),e.$nextTick((function(){this.scrollToView="msg"+o[0].id,this.$nextTick((function(){this.scrollAnimation=!0}))})),2==o[0].mediaType&&e.msgImgList.push(o[0].content),o[0].sendId==account&&t.vibrateLong()}))},showPic:function(e){t.previewImage({indicator:"none",current:e,urls:this.msgImgList})},playVoice:function(t,e){this.playMsgid=e,this.AUDIO.src=t,this.$nextTick((function(){this.AUDIO.play()}))},voiceBegin:function(t){console.log("开始录制"),console.log(t),t.touches.length>1||(this.initPoint.Y=t.touches[0].clientY,this.initPoint.identifier=t.touches[0].identifier,this.RECORDER.start({format:"mp3"}))},recordBegin:function(t){var e=this;this.recording=!0,this.voiceTis="松开 结束",this.recordLength=0,this.recordTimer=setInterval((function(){e.recordLength++}),1e3)},voiceCancel:function(){this.recording=!1,this.voiceTis="按住 说话",this.recordTis="手指上滑 取消发送",this.willStop=!0,this.RECORDER.stop()},voiceIng:function(e){if(this.recording){var i=e.touches[0];this.initPoint.Y-i.clientY>=t.upx2px(100)?(this.willStop=!0,this.recordTis="松开手指 取消发送"):(this.willStop=!1,this.recordTis="手指上滑 取消发送")}},voiceEnd:function(t){this.recording&&(this.recording=!1,this.voiceTis="按住 说话",this.recordTis="手指上滑 取消发送",this.RECORDER.stop())},recordEnd:function(e){var i=this;if(clearInterval(this.recordTimer),this.willStop)console.log("取消发送录音");else{if(console.log("要上传的语音"),console.log(e.tempFilePath),console.log("要上传语音的时长"),console.log(this.recordLength),this.recordLength<1)return void this.$u.toast("时间过短，请重新录制");t.uploadFile({url:i.sendChatUrl,method:"POST",filePath:e.tempFilePath,name:"file",formData:{from:i.id,toUser:i.account,mediaType:6,message:this.recordLength},success:function(t){var e=t.data;console.log("上传语音成功"+e),i.getNewData()}})}this.willStop=!1},switchVoice:function(){this.hideDrawer(),this.isVoice=!this.isVoice},discard:function(){}}};e.default=r}).call(this,i("543d")["default"])}},[["1001","common/runtime","common/vendor"]]]);